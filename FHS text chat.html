<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>P2P Chat — 640×640 + sfondo condiviso</title>
  <style>
    :root {
      --gap: .7rem;
      --bg: #e5ddd5;
      --me: #d1f1c9;
      --peer: #ffffff;
      --txt: #111827;
      --muted:#6b7280;
      --border:#d0d7de;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:#ececec; color:var(--txt);
      display:grid; place-items:center;
      padding: 1rem;
    }

    /* CONTENITORE FISSO 640x640 */
    #app {
      width: 640px; height: 640px;
      background: var(--bg);
      border: 1px solid #d6d3d1;
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
      position: relative;
    }

    header {
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      padding: .6rem .9rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { font-size:1rem; margin:0; font-weight:600; }
    .code { font-weight:700; letter-spacing:.06em; padding:.15rem .45rem; border:1px dashed #ccd; border-radius:.4rem; background:#fff; }

    /* Banner di stato */
    #banner { display:none; padding:.5rem .9rem; font-weight:600; }
    .banner-warn { background:#fff7ed; color:#92400e; border-bottom:1px solid #fde68a; }
    .banner-err  { background:#fef2f2; color:#991b1b; border-bottom:1px solid #fecaca; }

    /* Barra azioni */
    #actions {
      background:#fbfbfb;
      border-bottom:1px solid #eee;
      padding: .4rem .6rem;
      display:flex; gap:.4rem; align-items:center; flex-wrap:wrap;
    }
    #actions button, #actions input[type="text"] {
      border:1px solid var(--border); background:#fff; border-radius:8px; padding:.45rem .7rem; cursor:pointer;
    }
    #actions input[type="text"] { flex:1; cursor:text; }
    #actions button.primary { border-color:#16a34a; background:#22c55e; color:#fff; font-weight:600; }
    #actions button:disabled { opacity:.6; cursor:not-allowed; }

    /* Chat */
    #logWrap {
      position:relative;
      overflow:hidden;
    }
    #log {
      position:absolute; inset:0;
      padding: .9rem .9rem 0;
      overflow:auto;
      display:flex; flex-direction: column; gap: .35rem;
      background:
        radial-gradient(#00000006 1px, transparent 1px) 0 0/12px 12px,
        var(--bg);
      background-size: cover;            /* per lo sfondo condiviso */
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Bubbles */
    .bubble {
      max-width: min(78%, 560px);
      padding: .55rem .7rem;
      border-radius: .9rem;
      position: relative;
      box-shadow: 0 1px 0 rgba(0,0,0,.05);
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.25;
      display:inline-block;
    }
    .msg { display:flex; padding: .05rem .3rem; }
    .msg.peer { justify-content:flex-start; }
    .msg.me   { justify-content:flex-end; }
    .msg.peer .bubble { background: var(--peer); border:1px solid #eef2f7; border-top-left-radius:.2rem; }
    .msg.me   .bubble { background: var(--me);   border:1px solid #cfe9c7; border-top-right-radius:.2rem; }
    .system { color:#475569; font-size:.85rem; text-align:center; padding:.3rem 0; }
    .system[data-prep="1"] { opacity:.9; }

    /* Composer */
    .composer {
      background:#f8fafc;
      border-top:1px solid #e5e7eb;
      padding:.6rem .6rem;
      display:flex; gap:.5rem; align-items:center;
    }
    #text {
      flex:1; padding:.6rem .8rem; border:1px solid var(--border);
      border-radius: 999px; outline: none; background:#fff;
    }
    #sendBtn {
      padding:.6rem 1rem; border:1px solid #16a34a; background:#22c55e; color:#fff;
      border-radius:999px; cursor:pointer; font-weight:600;
    }
    #sendBtn:disabled { opacity:.6; cursor:not-allowed; }
    .status { color:#374151; font-size:.85rem; }
    .pill { display:inline-block; padding:.1rem .45rem; border-radius:999px; background:#e5e7eb; font-size:.78rem; margin-left:.4rem; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>P2P Chat</h1>
      <div class="status">Stato: <span id="status">offline</span> <span id="sigPill" class="pill" title="signaling">SSE</span></div>
      <div>Codice: <span id="codeBox" class="code">—</span></div>
    </header>

    <div id="banner" role="status"></div>

    <!-- Barra azioni -->
    <div id="actions">
      <button id="createBtn" title="Crea chat">Crea</button>
      <input id="joinCode" type="text" placeholder="Inserisci codice o crea" maxlength="24">
      <button id="joinBtn">Entra</button>
      <button id="bgBtn">Sfondo</button>
      <button id="bgClearBtn">Togli sfondo</button>
      <input id="bgFile" type="file" accept="image/*" style="display:none">
      <button id="copyLinkBtn">Copia link</button>
    </div>

    <!-- Chat -->
    <div id="logWrap">
      <main id="log" aria-live="polite" aria-label="Messaggi della chat"></main>
    </div>

    <div class="composer">
      <input id="text" type="text" placeholder="Scrivi un messaggio…">
      <button id="sendBtn" disabled>Invia</button>
    </div>
  </div>

<script>
/* ====== Config ====== */
const STUNS = [{ urls: 'stun:stun.l.google.com:19302' }];
// Aggiungi TURN per reti restrittive (sostituisci con il tuo):
const TURNS = [
  // { urls: 'turns:turn.tuodominio.it:5349', username: 'user', credential: 'pass' }
];
const SIGNAL_BASE = 'https://ntfy.sh';

/* ====== Stato ====== */
let pc, dc, roomCode = null, isOfferer = false, sse, currentTopic = null;
const selfId = crypto.getRandomValues(new Uint32Array(1))[0].toString(16);

let pendingCandidates = [];
let remoteSet = false;
let offerSent = false;
let answerSent = false;

let sseBackoff = 1000;      // ms
const SSE_BACKOFF_MAX = 10000;
let sseUp = false;

/* ====== UI ====== */
const $ = (id) => document.getElementById(id);
const logEl = $('log');
const sigPill = $('sigPill');
const appEl = $('app');

function showBanner(text, type='warn'){
  const el = $('banner');
  el.textContent = text;
  el.className = type === 'err' ? 'banner-err' : 'banner-warn';
  el.style.display = 'block';
}
function hideBanner(){ const el=$('banner'); el.style.display='none'; el.textContent=''; el.className=''; }

/* Messaggi di sistema.
   Se prep=true, il messaggio verrà rimosso automaticamente quando la connessione P2P è stabilita */
function logSys(t, prep=false){
  const d=document.createElement('div'); d.className='system'; d.textContent=t;
  if (prep) d.dataset.prep = "1";
  logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
}
function clearPrepMessages(){
  [...logEl.querySelectorAll('.system[data-prep="1"]')].forEach(n => n.remove());
}
function logBubble(side, text){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + side;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  const span = document.createElement('span'); span.textContent = text;
  bubble.appendChild(span);
  wrap.appendChild(bubble);
  logEl.appendChild(wrap); logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s){ $('status').textContent = s; }
function setSendEnabled(en){ $('sendBtn').disabled = !en; }
function genCode(){ return 'P2P-' + Math.random().toString(36).slice(2,7).toUpperCase(); }
function topic(code){ return `p2pchat-${code}`; }
function currentBaseURL(){ const u = new URL(window.location.href); return `${u.origin}${u.pathname}`; }
function makeInviteLink(code){ const u=new URL(currentBaseURL()); u.searchParams.set('code',code); u.searchParams.set('join','1'); return u.toString(); }
async function copyToClipboard(text){ try{ await navigator.clipboard.writeText(text); return true;} catch{ return false; }}

/* ====== Eventi UI ====== */
$('createBtn').onclick = async () => {
  roomCode = genCode(); $('codeBox').textContent = roomCode; isOfferer = true;
  const link = makeInviteLink(roomCode);
  if (await copyToClipboard(link)) logSys('Link invito copiato negli appunti.', true);
  await start(roomCode);
  logSys('Condividi il link invito con l’altra persona.', true);
};
$('joinBtn').onclick = async () => {
  const code = $('joinCode').value.trim().toUpperCase();
  if (!code) return;
  roomCode = code; $('codeBox').textContent = code; isOfferer = false;
  await start(roomCode);
};
$('copyLinkBtn').onclick = async () => {
  if (!roomCode) return;
  const link = makeInviteLink(roomCode);
  if (await copyToClipboard(link)) logSys('Link copiato.', true);
};
$('sendBtn').onclick = sendMessage;
$('text').addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

/* Sfondo condiviso */
$('bgBtn').onclick = () => $('bgFile').click();
$('bgFile').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const dataUrl = await fileToDataUrl(file);
  applyBackground(dataUrl);
  // invia al peer
  sendControl({ kind:'bg', dataUrl });
  e.target.value = '';
});
$('bgClearBtn').onclick = () => {
  applyBackground(null);
  sendControl({ kind:'bg-clear' });
});
function applyBackground(dataUrl){
  if (dataUrl) {
    logEl.style.backgroundImage = `url("${dataUrl}")`;
  } else {
    logEl.style.backgroundImage = 'none';
  }
}
/* Helpers file -> dataURL */
function fileToDataUrl(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ====== Messaggi ====== */
function sendControl(obj){
  if (!dc || dc.readyState !== 'open') return;
  dc.send(JSON.stringify({ t:'ctrl', ...obj }));
}
function sendText(text){
  if (!dc || dc.readyState !== 'open') return;
  dc.send(JSON.stringify({ t:'txt', text }));
}
function handleIncoming(raw){
  // Supporta sia JSON (nuovo) che testo semplice (compat)
  try {
    const msg = JSON.parse(raw);
    if (msg.t === 'txt') {
      logBubble('peer', msg.text);
    } else if (msg.t === 'ctrl') {
      if (msg.kind === 'bg' && msg.dataUrl) {
        applyBackground(msg.dataUrl);
        logSys('Sfondo aggiornato dal peer.');
      } else if (msg.kind === 'bg-clear') {
        applyBackground(null);
        logSys('Sfondo rimosso dal peer.');
      }
    } else {
      // ignora o mostra raw
      logBubble('peer', raw);
    }
  } catch {
    logBubble('peer', raw);
  }
}
function sendMessage(){
  const text = $('text').value;
  if (!text) return;
  sendText(text);
  logBubble('me', text);
  $('text').value='';
}

/* ====== Avvio ====== */
async function start(code){
  setStatus('preparazione…');
  hideBanner();
  setupPeer();
  openSSE(topic(code));           // apre SSE con backoff
  await publish({ t:'hello' });   // annuncia presenza
  logSys('Collegamento al signaling…', true);
  logSys('In attesa handshake…', true);
  setStatus('in attesa handshake…');
}

/* ====== WebRTC ====== */
function setupPeer(){
  pendingCandidates = []; remoteSet = false; offerSent = false; answerSent = false;

  pc = new RTCPeerConnection({ iceServers: [...STUNS, ...TURNS], iceTransportPolicy: 'all' });

  pc.oniceconnectionstatechange = () => {
    const st = pc.iceConnectionState;
    if (st === 'failed' || st === 'disconnected') {
      showBanner('Connessione al peer interrotta. Sto tentando di riprendere…', 'err');
    }
    if (st === 'connected' || st === 'completed') {
      hideBanner();
    }
  };

  pc.onconnectionstatechange = () => {
    const st = pc.connectionState;
    if (st === 'connected'){
      setStatus('P2P connesso'); setSendEnabled(true);
      clearPrepMessages(); // <- rimuovi i messaggi di preparazione
      hideBanner();
      logSys('Chat pronta.');
    } else if (['disconnected','failed'].includes(st)){
      setStatus('connessione persa'); setSendEnabled(false);
      showBanner('Peer non raggiungibile al momento.', 'err');
    }
  };

  if (isOfferer) {
    dc = pc.createDataChannel('chat');
    wireDC(dc);
  } else {
    pc.ondatachannel = (ev) => { dc = ev.channel; wireDC(dc); };
  }

  pc.onicecandidate = (ev) => { if (ev.candidate) publish({ t:'candidate', candidate: ev.candidate }); };
}

function wireDC(ch){
  ch.onopen  = () => { setSendEnabled(true); hideBanner(); };
  ch.onclose = () => { setSendEnabled(false); showBanner('Il peer ha chiuso la chat.', 'err'); };
  ch.onmessage = (ev) => handleIncoming(ev.data);
}

/* ====== Signaling (SSE con auto-reconnect) ====== */
function openSSE(tpc){
  currentTopic = tpc;
  if (sse) { sse.close(); sse = null; }
  const url = `${SIGNAL_BASE}/${tpc}/sse`;
  sse = new EventSource(url);
  sse.onopen = () => {
    sseUp = true; sseBackoff = 1000; sigPill.style.background='#dcfce7'; sigPill.style.border='1px solid #86efac';
    logSys('Collegato al signaling', true); hideBanner();
  };
  sse.onerror = () => {
    if (sseUp) { showBanner('Signaling disconnesso. Riconnessione in corso…', 'warn'); }
    sseUp = false; sigPill.style.background='#fde68a'; sigPill.style.border='1px solid #fbbf24';
    try { sse.close(); } catch {}
    setTimeout(() => openSSE(tpc), sseBackoff);
    sseBackoff = Math.min(SSE_BACKOFF_MAX, sseBackoff * 1.8);
  };
  sse.onmessage = async (ev) => {
    try {
      const envelope = JSON.parse(ev.data);
      if (!envelope || typeof envelope.message !== 'string') return;
      const msg = JSON.parse(envelope.message);
      if (!msg || msg.from === selfId) return;
      await handleSignal(msg);
    } catch (e) { console.warn('SSE parse error', e); }
  };
}

async function publish(obj){
  if (!roomCode) return;
  const body = JSON.stringify({ ...obj, from: selfId });
  return fetch(`${SIGNAL_BASE}/${topic(roomCode)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
    body
  }).catch(()=>{ /* il server potrebbe essere giù: l’auto-reconnect SSE ci riallinea */ });
}

async function maybeSendOffer(){
  if (!isOfferer || offerSent) return;
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await publish({ t:'offer', sdp: pc.localDescription });
  offerSent = true;
  logSys('Offer inviata.', true);
}

async function handleSignal(msg){
  if (msg.t === 'hello') {
    logSys('Peer presente.', true);
    await maybeSendOffer();

  } else if (msg.t === 'offer') {
    await pc.setRemoteDescription(msg.sdp);
    remoteSet = true;
    for (const c of pendingCandidates) {
      try { await pc.addIceCandidate(c); } catch (e) { console.warn('addIceCandidate buffered fail', e); }
    }
    pendingCandidates = [];
    if (!answerSent) {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await publish({ t:'answer', sdp: pc.localDescription });
      answerSent = true;
      logSys('Answer inviata.', true);
    }

  } else if (msg.t === 'answer') {
    await pc.setRemoteDescription(msg.sdp);
    remoteSet = true;
    for (const c of pendingCandidates) {
      try { await pc.addIceCandidate(c); } catch (e) { console.warn('addIceCandidate buffered fail', e); }
    }
    pendingCandidates = [];

  } else if (msg.t === 'candidate') {
    if (remoteSet && pc.remoteDescription) {
      try { await pc.addIceCandidate(msg.candidate); } catch (e) { console.warn('addIceCandidate fail', e); }
    } else {
      pendingCandidates.push(msg.candidate);
    }
  }
}

/* ====== Auto-join da URL ====== */
(function autoFromURL(){
  const url = new URL(window.location.href);
  const code = (url.searchParams.get('code') || '').trim().toUpperCase();
  const join = url.searchParams.get('join') === '1';
  if (code) {
    $('joinCode').value = code;
    if (join) {
      isOfferer = false;
      roomCode = code;
      $('codeBox').textContent = code;
      start(code);
    }
  }
})();

/* ====== Network awareness ====== */
window.addEventListener('offline', () => showBanner('Sei offline. Verifica la connessione.', 'warn'));
window.addEventListener('online',  () => { hideBanner(); if (currentTopic) openSSE(currentTopic); });

</script>
</body>
</html>
