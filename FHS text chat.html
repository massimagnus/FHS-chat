<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P2P Chat — menu + specchio + storia + quit</title>
<style>
  :root{
    --bg: #0a0a0a;      /* pagina */
    --card:#e5ddd5;     /* area app */
    --bar:#f8fafc;      /* header/composer */
    --line:#e5e7eb;
    --me:#d1f1c9;       /* bubble ultimo mio */
    --peer:#ffffff;     /* bubble ultimo peer */
    --me-old:#b6d9ae;   /* bubble vecchi miei */
    --peer-old:#e6e6e6; /* bubble vecchi peer */
    --muted:#6b7280;
    --danger:#ef4444;
    --warn:#f59e0b;
    --ok:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:grid; place-items:center; padding:1rem; color:#111827;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* Contenitore fisso 640x640 */
  #app{ width:640px; height:640px; background:var(--card); border:1px solid #d6d3d1;
        border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.15); overflow:hidden; position:relative; }
  .screen{ position:absolute; inset:0; display:none; }
  .screen.active{ display:grid; }

  /* --- Setup screen --- */
  #setup{ grid-template-rows:auto 1fr auto; background:#111; color:#fff; }
  #setup header{ padding:.8rem .9rem; background:#000; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
  #setup main{ display:grid; place-items:center; padding:1rem; }
  #setup .panel{ width:88%; max-width:520px; background:#141414; border:1px solid #222; border-radius:12px; padding:1rem; }
  .row{ display:flex; gap:.6rem; }
  .col{ flex:1 }
  label{ display:block; font-size:.9rem; color:#cbd5e1; margin:.35rem 0 .2rem }
  input[type=text]{ width:100%; padding:.6rem .7rem; border:1px solid #333; background:#0b0b0b; color:#fff; border-radius:8px; }
  .radio{ display:flex; gap:.8rem; align-items:center; margin:.2rem 0 .8rem }
  .radio label{ display:flex; align-items:center; gap:.35rem; cursor:pointer; margin:0; }
  .hint{ color:#9ca3af; font-size:.85rem; margin-top:.4rem }
  .btn{ padding:.6rem 1rem; border-radius:10px; cursor:pointer; border:1px solid #2d2d2d; background:#1a1a1a; color:#fff; }
  .btn.primary{ background:var(--ok); border-color:#16a34a; color:#07210c; font-weight:700; }
  .btn:disabled{ opacity:.6; cursor:not-allowed }

  /* --- Main screen --- */
  #main{ grid-template-rows: auto auto 1fr auto; }
  header.bar{ background:var(--bar); border-bottom:1px solid var(--line); padding:.55rem .8rem; display:flex; align-items:center; justify-content:space-between; }
  .status{ font-size:.9rem; color:#374151 }
  .pill{ display:inline-block; padding:.12rem .45rem; border-radius:999px; background:#e5e7eb; font-size:.75rem; margin-left:.35rem; }
  .controls{ display:flex; gap:.4rem; }
  .controls .btn{ background:#fff; border:1px solid #d0d7de; color:#111; }
  .controls .danger{ background:#fee2e2; border-color:#fecaca; color:#7f1d1d; }

  #banner{ display:none; padding:.5rem .9rem; font-weight:600; }
  .banner-warn{ background:#fff7ed; color:#92400e; border-bottom:1px solid #fde68a }
  .banner-err{ background:#fef2f2; color:#991b1b; border-bottom:1px solid #fecaca }

  /* Area pulsanti (sopra specchio) */
  #actions{ background:#fbfbfb; border-bottom:1px solid #eee; padding:.35rem .6rem;
            display:flex; gap:.4rem; align-items:center; flex-wrap:wrap; }
  #actions .btn{ background:#fff; border:1px solid #d0d7de; color:#111; }
  #actions input[type=file]{ display:none }

  /* Area Specchio + Nomi */
  #stage{ display:grid; grid-template-rows: 1fr auto; }
  #specchioWrap{ position:relative; overflow:hidden; border-bottom:1px solid rgba(0,0,0,.08); }
  #specchio{
    position:absolute; inset:0; background:#10b981;     /* verde “specchio” di default */
    background-size:cover; background-position:center; background-repeat:no-repeat;
  }
  /* Chat */
  #chat{
    display:grid; grid-template-rows: auto 1fr; height:100%;
    background:
      radial-gradient(#00000006 1px, transparent 1px) 0 0/12px 12px,
      var(--card);
  }
  #names{ display:grid; grid-template-columns:1fr 1fr; padding:.35rem .6rem; font-weight:700; color:#374151; font-size:.9rem; }
  #names div{ text-align:center }
  #grid{
    display:grid; grid-template-columns:1fr 1fr; gap:.4rem;
    padding:.5rem .6rem; overflow:auto;
  }
  .colList{ display:flex; flex-direction:column; gap:.35rem; }
  .bubble{ display:inline-block; max-width:90%; padding:.45rem .6rem; border-radius:.8rem; box-shadow:0 1px 0 rgba(0,0,0,.06); word-wrap:break-word; white-space:pre-wrap; line-height:1.25; }
  /* Ultimi messaggi */
  .colList.me   .bubble.last{ background:var(--me); border:1px solid #cfe9c7; font-size:1rem }
  .colList.peer .bubble.last{ background:var(--peer); border:1px solid #eef2f7; font-size:1rem }
  /* Precedenti (piccoli e scuri) */
  .colList.me   .bubble:not(.last){ background:var(--me-old);  border:1px solid #b2d0aa;  font-size:.85rem; opacity:.85 }
  .colList.peer .bubble:not(.last){ background:var(--peer-old);border:1px solid #dfdfdf;  font-size:.85rem; opacity:.85 }

  /* Composer */
  .composer{ background:var(--bar); border-top:1px solid var(--line); padding:.55rem .6rem; display:flex; gap:.5rem; align-items:center; }
  #text{ flex:1; padding:.6rem .8rem; border:1px solid #d0d7de; border-radius:999px; background:#fff; }
  #sendBtn{ padding:.6rem 1rem; border:1px solid #16a34a; background:var(--ok); color:#fff; border-radius:999px; font-weight:700; }
  #sendBtn:disabled{ opacity:.6; cursor:not-allowed }

  /* History overlay */
  #history{ position:absolute; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; }
  #history .card{ width:86%; max-width:540px; max-height:70%; background:#fff; border-radius:12px; border:1px solid #e5e7eb; display:flex; flex-direction:column; }
  #history header{ padding:.5rem .8rem; font-weight:700; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center }
  #history main{ padding:.6rem .8rem; overflow:auto; }
  .hrow{ display:flex; gap:.5rem; margin:.15rem 0; }
  .hwho{ width:80px; font-weight:700; color:#6b7280; }
  .htext{ flex:1; }

  /* Banner errore JS */
  #jsErr{ position:absolute; inset:auto 12px 12px 12px; background:#fee2e2; color:#7f1d1d; padding:.5rem .75rem; border:1px solid #fecaca; border-radius:8px; display:none; font-weight:700; }
</style>
</head>
<body>
<div id="app">

  <!-- Setup -->
  <section id="setup" class="screen active">
    <header><strong>Impostazioni</strong><span style="color:#9ca3af">P2P WebRTC</span></header>
    <main>
      <div class="panel">
        <div class="row">
          <div class="col">
            <label for="nickMe">Il tuo nickname</label>
            <input id="nickMe" type="text" placeholder="Es. Marco" maxlength="24">
          </div>
          <div class="col">
            <label for="room">Codice stanza (solo CLIENT)</label>
            <input id="room" type="text" placeholder="Es. P2P-AB123" maxlength="24">
          </div>
        </div>
        <div class="radio">
          <label><input type="radio" name="role" value="server" checked> SERVER (crea)</label>
          <label><input type="radio" name="role" value="client"> CLIENT (entra)</label>
        </div>
        <div class="row">
          <button id="btnStart" class="btn primary" style="flex:1">Avvia</button>
          <button id="btnPaste" class="btn" title="Incolla codice dagli appunti">Incolla codice</button>
        </div>
        <div class="hint">SERVER genera il codice e condivide il link. CLIENT inserisce il codice e si collega.</div>
      </div>
    </main>
    <footer style="padding:.65rem .9rem; color:#9ca3af; border-top:1px solid #222">Nessun dato su server: il flusso viaggia P2P tra i browser.</footer>
  </section>

  <!-- Main -->
  <section id="main" class="screen">

    <header class="bar">
      <div class="status">Stato: <span id="status">offline</span> <span id="pillSSE" class="pill">SSE</span></div>
      <div class="controls">
        <button id="btnHistory" class="btn">STORIA</button>
        <button id="btnQuit" class="btn danger">ESCI</button>
      </div>
    </header>

    <div id="banner" role="status"></div>

    <div id="actions">
      <button id="btnBg"   class="btn">Sfondo</button>
      <button id="btnBgClr" class="btn">Togli sfondo</button>
      <input id="fileBg" type="file" accept="image/*">

      <button id="btnSpec" class="btn">Specchio</button>
      <button id="btnSpecClr" class="btn">Togli specchio</button>
      <input id="fileSpec" type="file" accept="image/*">

      <span style="margin-left:auto; color:#6b7280; font-size:.9rem">Codice: <strong id="codeBox">—</strong></span>
    </div>

    <div id="stage">
      <div id="specchioWrap">
        <div id="specchio" aria-label="Specchio"></div>
      </div>
      <div id="chat">
        <div id="names">
          <div id="nameClient">CLIENT</div>
          <div id="nameServer">SERVER</div>
        </div>
        <div id="grid">
          <div id="colClient" class="colList peer"></div>
          <div id="colServer" class="colList me"></div>
        </div>
      </div>
    </div>

    <div class="composer">
      <input id="text" type="text" placeholder="Scrivi un messaggio…">
      <button id="sendBtn" disabled>Invia</button>
    </div>
  </section>

  <!-- History overlay -->
  <div id="history">
    <div class="card">
      <header>Storia conversazione <button id="btnCloseHist" class="btn">Chiudi</button></header>
      <main id="histBody"></main>
    </div>
  </div>

  <div id="jsErr"></div>
</div>

<script>
/* ====================== Error banner globale ====================== */
window.addEventListener('error', function(e){
  try{
    var msg = e && e.message ? e.message : 'Errore sconosciuto';
    var where = e && e.filename ? (' @ ' + e.filename + ':' + e.lineno) : '';
    var el = document.getElementById('jsErr');
    el.textContent = 'Errore script: ' + msg + where;
    el.style.display = 'block';
    console.error('Errore globale', e);
  }catch{}
});

/* ====================== Config e stato base ====================== */
var STUNS = [{ urls: 'stun:stun.l.google.com:19302' }];
var TURNS = [ /* { urls:'turns:turn.tuodominio.it:5349', username:'user', credential:'pass' } */ ];
var SIGNAL_BASE = 'https://ntfy.sh';

var pc=null, dc=null, sse=null;
var isServer=false;
var roomCode=null, baseTopic=null, topicGen='0', currentTopic=null;
var selfId = crypto.getRandomValues(new Uint32Array(1))[0].toString(16);

var pendingCandidates=[], remoteSet=false, offerSent=false, answerSent=false;
var sseBackoff=1000, SSE_BACKOFF_MAX=10000, sseUp=false;
var switching=false, dcCloseTimer=null, discTimer=null;

/* Nomi */
var myNick='Io', peerNick='Peer';

/* History (per sessione). Si azzera su nuova sessione o ESCI. */
var history=[], historyEnabled=true;

/* ====================== Helpers UI ====================== */
function $(id){return document.getElementById(id)}
function setScreen(name){
  $('#setup').classList.remove('active');
  $('#main').classList.remove('active');
  $('#'+name).classList.add('active');
}
function setStatus(s){ $('#status').textContent=s }
function showBanner(t,kind){ var el=$('#banner'); el.textContent=t; el.className = kind==='err'?'banner-err':'banner-warn'; el.style.display='block'; }
function hideBanner(){ var el=$('#banner'); el.style.display='none'; el.textContent=''; el.className='' }
function genCode(){ return 'P2P-' + Math.random().toString(36).slice(2,7).toUpperCase() }
function topicBase(code){ return 'p2pchat-'+code }
function buildTopic(){ return baseTopic+'-'+topicGen }
function copyToClipboard(t){ return (navigator.clipboard && navigator.clipboard.writeText) ? navigator.clipboard.writeText(t).then(function(){return true}).catch(function(){return false}) : Promise.resolve(false) }
function currentBaseURL(){ var u=new URL(location.href); return u.origin+u.pathname }
function makeInviteLink(code){ var u=new URL(currentBaseURL()); u.searchParams.set('code',code); u.searchParams.set('join','1'); return u.toString() }

function labelNames(){
  $('#nameClient').textContent = 'CLIENT: ' + (isServer? peerNick : myNick);
  $('#nameServer').textContent = 'SERVER: ' + (isServer? myNick : peerNick);
}

/* Bubbles side-by-side */
function appendMsg(side, text){
  // side: 'client' | 'server'
  var col = side==='client' ? $('#colClient') : $('#colServer');
  // rimuovi "last" corrente in quella colonna
  var olds = col.querySelectorAll('.bubble.last');
  for (var i=0;i<olds.length;i++) olds[i].classList.remove('last');
  // append
  var b=document.createElement('div'); b.className='bubble last'; b.textContent=text;
  col.appendChild(b); col.parentElement.scrollTop = col.parentElement.scrollHeight;

  // history
  if(historyEnabled){ history.push({side:side, text:text}); }
}
function redrawHistory(){
  var body=$('#histBody'); body.innerHTML='';
  for (var i=0;i<history.length;i++){
    var row=document.createElement('div'); row.className='hrow';
    var who=document.createElement('div'); who.className='hwho'; who.textContent=history[i].side.toUpperCase();
    var txt=document.createElement('div'); txt.className='htext'; txt.textContent=history[i].text;
    row.appendChild(who); row.appendChild(txt); body.appendChild(row);
  }
}

/* Sfondo + Specchio */
function setBackground(dataUrl){ var grid=$('#grid'); if(dataUrl){ grid.style.backgroundImage='url("'+dataUrl+'")'; grid.style.backgroundSize='cover'; grid.style.backgroundPosition='center'; } else { grid.style.backgroundImage='none'; } }
function setSpecchio(dataUrl){ var s=$('#specchio'); if(dataUrl){ s.style.backgroundImage='url("'+dataUrl+'")'; } else { s.style.backgroundImage='none'; } }
function fileToDataUrl(file){ return new Promise(function(res,rej){ var fr=new FileReader(); fr.onload=function(){res(fr.result)}; fr.onerror=rej; fr.readAsDataURL(file); }); }

/* ====================== SETUP UI events ====================== */
$('#btnPaste').onclick=function(){
  if(!navigator.clipboard) return;
  navigator.clipboard.readText().then(function(t){ $('#room').value=t.trim() }).catch(function(){});
};
$('#btnStart').onclick=function(){
  myNick = ($('#nickMe').value || 'Io').trim();
  var role = document.querySelector('input[name="role"]:checked').value;
  isServer = (role==='server');
  if(isServer){
    roomCode = genCode(); baseTopic=topicBase(roomCode); topicGen='0'; currentTopic=buildTopic();
    $('#codeBox').textContent = roomCode;
    setScreen('main');
    afterEnterMain(true/*newSession*/);
    startSession(true/*resetHistory*/);
    var link = makeInviteLink(roomCode);
    copyToClipboard(link);
  }else{
    var code=($('#room').value||'').trim().toUpperCase();
    if(!code) { alert('Inserisci un codice stanza'); return; }
    roomCode = code; baseTopic=topicBase(roomCode); topicGen='0'; currentTopic=buildTopic();
    $('#codeBox').textContent = roomCode;
    setScreen('main');
    afterEnterMain(true);
    startSession(true/*resetHistory*/);
  }
};

/* ====================== MAIN UI events ====================== */
$('#btnHistory').onclick=function(){ redrawHistory(); $('#history').style.display='flex'; }
$('#btnCloseHist').onclick=function(){ $('#history').style.display='none'; }
$('#btnQuit').onclick=function(){ sendCtrl({kind:'quit'}); hardResetToSetup(); };

$('#btnBg').onclick=function(){ $('#fileBg').click(); }
$('#fileBg').addEventListener('change', function(e){
  var f = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
  if(!f) return;
  fileToDataUrl(f).then(function(dataUrl){ setBackground(dataUrl); sendCtrl({kind:'bg', dataUrl:dataUrl}); e.target.value=''; });
});
$('#btnBgClr').onclick=function(){ setBackground(null); sendCtrl({kind:'bg-clear'}); };

$('#btnSpec').onclick=function(){ $('#fileSpec').click(); }
$('#fileSpec').addEventListener('change', function(e){
  var f = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
  if(!f) return;
  fileToDataUrl(f).then(function(dataUrl){ setSpecchio(dataUrl); sendCtrl({kind:'spec', dataUrl:dataUrl}); e.target.value=''; });
});
$('#btnSpecClr').onclick=function(){ setSpecchio(null); sendCtrl({kind:'spec-clear'}); };

$('#sendBtn').onclick=sendMessage;
$('#text').addEventListener('keydown', function(e){ if(e.key==='Enter') sendMessage(); });

function afterEnterMain(newSession){
  // label nomi (CLIENT a sinistra, SERVER a destra)
  labelNames();
  // clear UI chat/sezioni se nuova sessione
  if(newSession){
    $('#colClient').innerHTML=''; $('#colServer').innerHTML='';
    setBackground(null); setSpecchio(null);
    history = []; // reset history solo su nuova sessione
  }
}

/* ====================== Messaging ====================== */
function sendMessage(){
  var t=$('#text').value; if(!t) return;
  var side = isServer ? 'server' : 'client';
  sendText(t);
  appendMsg(side, t);
  $('#text').value='';
}
function sendText(txt){
  if(!dc || dc.readyState!=='open') return;
  try{ dc.send(JSON.stringify({t:'txt', text:txt})); }catch(e){}
}
function sendCtrl(obj){
  if(dc && dc.readyState==='open'){
    try{ dc.send(JSON.stringify({t:'ctrl', role:(isServer?'server':'client')}, null)); }catch(e){}
  }
  // invia anche via signaling se quit (per essere sicuri arrivi)
  if(obj && obj.kind==='quit'){ publish({t:'quit'}); }
}
function handleIncoming(raw){
  try{
    var msg=JSON.parse(raw);
    if(msg.t==='txt'){
      var side = (isServer ? 'client' : 'server'); // l’altro lato
      appendMsg(side, msg.text);
    }else if(msg.t==='ctrl'){
      // no-op
    }
  }catch(_){
    // compat: testo semplice
    var side = (isServer ? 'client' : 'server');
    appendMsg(side, raw);
  }
}

/* ====================== Sessione / Signaling / RTC ====================== */
function startSession(resetHistory){
  setStatus('preparazione…'); hideBanner();
  historyEnabled = true; // tiene storia tra reconnect
  setupPeer();
  openSSE(currentTopic);
  publish({t:'hello', nick:myNick, role:(isServer?'server':'client')});
  setStatus('in attesa handshake…');
}
function openSSE(tpc){
  if(sse){ try{sse.close()}catch(e){} sse=null; }
  var url = SIGNAL_BASE + '/' + tpc + '/sse';
  sse = new EventSource(url);
  sse.onopen=function(){ sseUp=true; sseBackoff=1000; $('#pillSSE').style.background='#dcfce7'; $('#pillSSE').style.border='1px solid #86efac'; hideBanner(); };
  sse.onerror=function(){ if(sseUp){ showBanner('Signaling disconnesso. Riconnessione…','warn'); } sseUp=false; $('#pillSSE').style.background='#fde68a'; $('#pillSSE').style.border='1px solid #fbbf24';
    try{sse.close()}catch(e){}
    setTimeout(function(){ openSSE(tpc) }, sseBackoff); sseBackoff=Math.min(SSE_BACKOFF_MAX, Math.round(sseBackoff*1.8));
  };
  sse.onmessage=function(ev){
    try{
      var env=JSON.parse(ev.data); if(!env || typeof env.message!=='string') return;
      var msg=JSON.parse(env.message); if(!msg || msg.from===selfId) return;
      handleSignal(msg);
    }catch(e){ console.warn('SSE parse',e); }
  };
}
function publish(obj){
  if(!roomCode) return Promise.resolve();
  var body = JSON.stringify(Object.assign({}, obj, {from:selfId}));
  return fetch(SIGNAL_BASE + '/' + currentTopic, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:body }).catch(function(){});
}

function setupPeer(){
  pendingCandidates=[]; remoteSet=false; offerSent=false; answerSent=false;
  if(discTimer){ clearTimeout(discTimer); discTimer=null; }

  pc = new RTCPeerConnection({ iceServers: STUNS.concat(TURNS), iceTransportPolicy:'all' });

  pc.oniceconnectionstatechange=function(){
    var st=pc.iceConnectionState;
    if(st==='failed'){ showBanner('Connessione peer fallita. Riprovo…','err'); requestSwitch('ice-failed'); }
    else if(st==='disconnected'){ showBanner('Peer disconnesso. Attendo…','warn'); if(!discTimer) discTimer=setTimeout(function(){ requestSwitch('ice-disconnected') }, 2500); }
    else if(st==='connected' || st==='completed'){ if(discTimer){ clearTimeout(discTimer); discTimer=null; } hideBanner(); }
  };
  pc.onconnectionstatechange=function(){
    var st=pc.connectionState;
    if(st==='connected'){ setStatus('P2P connesso'); $('#sendBtn').disabled=false; hideBanner(); switching=false; }
    else if(st==='failed'){ setStatus('connessione fallita'); $('#sendBtn').disabled=true; requestSwitch('conn-failed'); }
    else if(st==='disconnected'){ setStatus('connessione persa'); $('#sendBtn').disabled=true; }
  };

  if(isServer){ dc = pc.createDataChannel('chat'); wireDC(dc); }
  else{ pc.ondatachannel=function(e){ dc=e.channel; wireDC(dc); }; }

  pc.onicecandidate=function(e){ if(e && e.candidate) publish({t:'candidate', candidate:e.candidate}); };
}
function wireDC(ch){
  ch.onopen=function(){ $('#sendBtn').disabled=false; hideBanner(); };
  ch.onclose=function(){ $('#sendBtn').disabled=true; showBanner('Canale dati chiuso. Riconnessione…','err'); if(dcCloseTimer) clearTimeout(dcCloseTimer); dcCloseTimer=setTimeout(function(){ requestSwitch('dc-closed') }, 600); };
  ch.onmessage=function(e){ handleIncoming(e.data); };
}

function maybeSendOffer(){
  if(!isServer || offerSent) return;
  pc.createOffer().then(function(of){ return pc.setLocalDescription(of); })
  .then(function(){ return publish({t:'offer', sdp:pc.localDescription}); })
  .then(function(){ offerSent=true; }).catch(function(e){ console.error(e); });
}

function handleSignal(msg){
  if(msg.t==='hello'){
    if(msg.nick){ peerNick = msg.nick; labelNames(); }
    maybeSendOffer();
  }else if(msg.t==='quit'){
    // Il peer ha lasciato: chiudi e torna al setup
    showBanner('Il peer ha lasciato la sessione.','warn');
    setTimeout(function(){ hardResetToSetup(); }, 250);
  }else if(msg.t==='switch'){
    if(msg.gen){ applySwitch(msg.gen); }
  }else if(msg.t==='need-switch'){
    if(isServer) requestSwitch('asked-by-peer');
  }else if(msg.t==='offer'){
    pc.setRemoteDescription(msg.sdp).then(function(){
      remoteSet=true;
      for(var i=0;i<pendingCandidates.length;i++){ pc.addIceCandidate(pendingCandidates[i]).catch(function(e){console.warn('addIce buffered',e)}); }
      pendingCandidates=[];
      if(!answerSent){
        return pc.createAnswer().then(function(ans){ return pc.setLocalDescription(ans); })
          .then(function(){ return publish({t:'answer', sdp:pc.localDescription}); })
          .then(function(){ answerSent=true; });
      }
    }).catch(function(e){ console.error(e); });
  }else if(msg.t==='answer'){
    pc.setRemoteDescription(msg.sdp).then(function(){
      remoteSet=true;
      for(var i=0;i<pendingCandidates.length;i++){ pc.addIceCandidate(pendingCandidates[i]).catch(function(e){console.warn('addIce buffered',e)}); }
      pendingCandidates=[];
    }).catch(function(e){ console.error(e); });
  }else if(msg.t==='candidate'){
    if(remoteSet && pc.remoteDescription){ pc.addIceCandidate(msg.candidate).catch(function(e){ console.warn('addIce',e); }); }
    else{ pendingCandidates.push(msg.candidate); }
  }
}

/* ====== Riconnessione coordinata (topic switching) ====== */
function requestSwitch(why){
  if(switching) return; switching=true;
  if(isServer){
    var newGen = Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,6);
    publish({t:'switch', gen:newGen, why:why}).then(function(){ setTimeout(function(){ applySwitch(newGen); }, 120); })
      .catch(function(){ setTimeout(function(){ applySwitch(newGen); }, 200); });
  }else{
    publish({t:'need-switch', why:why});
  }
}
function applySwitch(newGen){
  cleanupPeer();
  topicGen = newGen; currentTopic = buildTopic();
  openSSE(currentTopic);
  setupPeer();
  publish({t:'hello', nick:myNick, role:(isServer?'server':'client')});
  setStatus('riconnessione…'); hideBanner();
}
function cleanupPeer(){
  try{ if(dc){ dc.onopen=dc.onclose=dc.onmessage=null; dc.close(); } }catch(_){}
  try{ if(pc){ pc.oniceconnectionstatechange=pc.onconnectionstatechange=pc.ondatachannel=null; pc.close(); } }catch(_){}
  dc=null; pc=null; pendingCandidates=[]; remoteSet=false; offerSent=false; answerSent=false;
}

/* ====== Quit / reset ====== */
function hardResetToSetup(){
  historyEnabled=false; // blocca append altra history
  try{ if(sse){ sse.close(); } }catch(_){}
  cleanupPeer();
  sse=null; currentTopic=null; baseTopic=null; roomCode=null;
  $('#codeBox').textContent='—';
  setBackground(null); setSpecchio(null);
  $('#colClient').innerHTML=''; $('#colServer').innerHTML='';
  history=[]; // azzera
  setStatus('offline');
  setScreen('setup');
}

/* ====== Auto-join da URL (client) ====== */
(function(){
  var url=new URL(location.href);
  var code=(url.searchParams.get('code')||'').trim().toUpperCase();
  var join=(url.searchParams.get('join')==='1');
  if(code){
    $('#room').value=code;
    if(join){
      // precompila client e avvia
      document.querySelector('input[name="role"][value="client"]').checked=true;
    }
  }
})();
</script>
</body>
</html>
