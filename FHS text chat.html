<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>P2P Chat — 640×640 + sfondo + autoreconnect</title>
  <style>
    :root {
      --gap: .7rem;
      --bg: #e5ddd5;
      --me: #d1f1c9;
      --peer: #ffffff;
      --txt: #111827;
      --muted:#6b7280;
      --border:#d0d7de;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:#ececec; color:var(--txt);
      display:grid; place-items:center; padding: 1rem;
    }

    /* CONTENITORE FISSO 640x640 */
    #app {
      width: 640px; height: 640px;
      background: var(--bg);
      border: 1px solid #d6d3d1;
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
      position: relative;
    }

    header {
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      padding: .6rem .9rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { font-size:1rem; margin:0; font-weight:600; }
    .code { font-weight:700; letter-spacing:.06em; padding:.15rem .45rem; border:1px dashed #ccd; border-radius:.4rem; background:#fff; }

    #banner { display:none; padding:.5rem .9rem; font-weight:600; }
    .banner-warn { background:#fff7ed; color:#92400e; border-bottom:1px solid #fde68a; }
    .banner-err  { background:#fef2f2; color:#991b1b; border-bottom:1px solid #fecaca; }

    #actions {
      background:#fbfbfb;
      border-bottom:1px solid #eee;
      padding: .4rem .6rem;
      display:flex; gap:.4rem; align-items:center; flex-wrap:wrap;
    }
    #actions button, #actions input[type="text"] {
      border:1px solid var(--border); background:#fff; border-radius:8px; padding:.45rem .7rem; cursor:pointer;
    }
    #actions input[type="text"] { flex:1; cursor:text; }
    #actions button.primary { border-color:#16a34a; background:#22c55e; color:#fff; font-weight:600; }
    #actions button:disabled { opacity:.6; cursor:not-allowed; }

    #logWrap { position:relative; overflow:hidden; }
    #log {
      position:absolute; inset:0;
      padding: .9rem .9rem 0;
      overflow:auto;
      display:flex; flex-direction: column; gap: .35rem;
      background:
        radial-gradient(#00000006 1px, transparent 1px) 0 0/12px 12px,
        var(--bg);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .bubble {
      max-width: min(78%, 560px);
      padding: .55rem .7rem;
      border-radius: .9rem;
      position: relative;
      box-shadow: 0 1px 0 rgba(0,0,0,.05);
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.25;
      display:inline-block;
    }
    .msg { display:flex; padding: .05rem .3rem; }
    .msg.peer { justify-content:flex-start; }
    .msg.me   { justify-content:flex-end; }
    .msg.peer .bubble { background: var(--peer); border:1px solid #eef2f7; border-top-left-radius:.2rem; }
    .msg.me   .bubble { background: var(--me);   border:1px solid #cfe9c7; border-top-right-radius:.2rem; }
    .system { color:#475569; font-size:.85rem; text-align:center; padding:.3rem 0; }
    .system[data-prep="1"] { opacity:.9; }

    .composer {
      background:#f8fafc;
      border-top:1px solid #e5e7eb;
      padding:.6rem .6rem;
      display:flex; gap:.5rem; align-items:center;
    }
    #text {
      flex:1; padding:.6rem .8rem; border:1px solid var(--border);
      border-radius: 999px; outline: none; background:#fff;
    }
    #sendBtn {
      padding:.6rem 1rem; border:1px solid #16a34a; background:#22c55e; color:#fff;
      border-radius:999px; cursor:pointer; font-weight:600;
    }
    #sendBtn:disabled { opacity:.6; cursor:not-allowed; }
    .status { color:#374151; font-size:.85rem; }
    .pill { display:inline-block; padding:.1rem .45rem; border-radius:999px; background:#e5e7eb; font-size:.78rem; margin-left:.4rem; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>P2P Chat</h1>
      <div class="status">Stato: <span id="status">offline</span> <span id="sigPill" class="pill" title="signaling">SSE</span></div>
      <div>Codice: <span id="codeBox" class="code">—</span></div>
    </header>

    <div id="banner" role="status"></div>

    <div id="actions">
      <button id="createBtn" title="Crea chat">Crea</button>
      <input id="joinCode" type="text" placeholder="Inserisci codice o crea (vx)" maxlength="24">
      <button id="joinBtn">Entra</button>
      <button id="bgBtn">Sfondo</button>
      <button id="bgClearBtn">Togli sfondo</button>
      <input id="bgFile" type="file" accept="image/*" style="display:none">
      <button id="copyLinkBtn">Copia link</button>
    </div>

    <div id="logWrap">
      <main id="log" aria-live="polite" aria-label="Messaggi della chat"></main>
    </div>

    <div class="composer">
      <input id="text" type="text" placeholder="Scrivi un messaggio…">
      <button id="sendBtn" disabled>Invia</button>
    </div>
  </div>

<script>
/* ====== Error banner globale ====== */
window.addEventListener('error', function (e){
  try {
    var msg = (e && e.message) ? e.message : 'Errore sconosciuto';
    var where = (e && e.filename) ? (' @ ' + e.filename + ':' + e.lineno) : '';
    showBanner('Errore script: ' + msg + where, 'err');
    console.error('Errore globale', e);
  } catch {}
});

/* ====== Config ====== */
var STUNS = [{ urls: 'stun:stun.l.google.com:19302' }];
var TURNS = [
  // { urls: 'turns:turn.tuodominio.it:5349', username: 'user', credential: 'pass' }
];
var SIGNAL_BASE = 'https://ntfy.sh';

/* ====== Stato ====== */
var pc, dc, roomCode = null, isOfferer = false, sse = null;
var selfId = crypto.getRandomValues(new Uint32Array(1))[0].toString(16);

/* Topic base e generazione (per switch coordinati) */
var baseTopic = null;
var topicGen = '0';              // iniziale
var currentTopic = null;         // baseTopic + '-' + topicGen

/* Flags RTC */
var pendingCandidates = [];
var remoteSet = false;
var offerSent = false;
var answerSent = false;

/* SSE backoff */
var sseBackoff = 1000;      // ms
var SSE_BACKOFF_MAX = 10000;
var sseUp = false;

/* Riconnessione P2P */
var switching = false;
var dcCloseTimer = null;
var discTimer = null;       // debounce su 'disconnected' (2.5s)

/* ====== UI ====== */
function $(id){ return document.getElementById(id); }
var logEl = $('log');
var sigPill = $('sigPill');

function showBanner(text, type){
  var el = $('banner');
  el.textContent = text;
  el.className = (type === 'err') ? 'banner-err' : 'banner-warn';
  el.style.display = 'block';
}
function hideBanner(){ var el=$('banner'); el.style.display='none'; el.textContent=''; el.className=''; }

function logSys(t, prep){
  var d=document.createElement('div'); d.className='system'; d.textContent=t;
  if (prep) d.setAttribute('data-prep','1');
  logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
}
function clearPrepMessages(){
  var nodes = logEl.querySelectorAll('.system[data-prep="1"]');
  for (var i=0;i<nodes.length;i++) nodes[i].remove();
}
function logBubble(side, text){
  var wrap = document.createElement('div');
  wrap.className = 'msg ' + side;
  var bubble = document.createElement('div');
  bubble.className = 'bubble';
  var span = document.createElement('span'); span.textContent = text;
  bubble.appendChild(span);
  wrap.appendChild(bubble);
  logEl.appendChild(wrap); logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s){ $('status').textContent = s; }
function setSendEnabled(en){ $('sendBtn').disabled = !en; }
function genCode(){ return 'P2P-' + Math.random().toString(36).slice(2,7).toUpperCase(); }
function topic(code){ return 'p2pchat-' + code; }
function buildTopic(){ return baseTopic + '-' + topicGen; }
function currentBaseURL(){ var u = new URL(window.location.href); return (u.origin + u.pathname); }
function makeInviteLink(code){ var u=new URL(currentBaseURL()); u.searchParams.set('code',code); u.searchParams.set('join','1'); return u.toString(); }
function copyToClipboard(text){
  return navigator.clipboard && navigator.clipboard.writeText
    ? navigator.clipboard.writeText(text).then(function(){ return true; }).catch(function(){ return false; })
    : Promise.resolve(false);
}

/* ====== Eventi UI ====== */
$('createBtn').onclick = function(){
  roomCode = genCode(); $('codeBox').textContent = roomCode; isOfferer = true;
  baseTopic = topic(roomCode); topicGen = '0'; currentTopic = buildTopic();
  logSys('Creo stanza ' + roomCode + '…', true);
  var link = makeInviteLink(roomCode);
  copyToClipboard(link).then(function(ok){
    if (ok) logSys('Link invito copiato negli appunti.', true);
    startSession();
    logSys('Condividi il link invito con l’altra persona.', true);
  });
};
$('joinBtn').onclick = function(){
  var code = $('joinCode').value.trim().toUpperCase();
  if (!code) return;
  roomCode = code; $('codeBox').textContent = code; isOfferer = false;
  baseTopic = topic(roomCode); topicGen = '0'; currentTopic = buildTopic();
  logSys('Entrando nella stanza ' + roomCode + '…', true);
  startSession();
};
$('copyLinkBtn').onclick = function(){
  if (!roomCode) return;
  var link = makeInviteLink(roomCode);
  copyToClipboard(link).then(function(ok){ if (ok) logSys('Link copiato.', true); });
};
$('sendBtn').onclick = sendMessage;
$('text').addEventListener('keydown', function(e){ if (e.key === 'Enter') sendMessage(); });

/* Sfondo condiviso */
$('bgBtn').onclick = function(){ $('bgFile').click(); };
$('bgFile').addEventListener('change', function(e){
  var tgt = e.target;
  var file = (tgt && tgt.files && tgt.files[0]) ? tgt.files[0] : null;
  if (!file) return;
  fileToDataUrl(file).then(function(dataUrl){
    applyBackground(dataUrl);
    sendControl({ kind:'bg', dataUrl: dataUrl });
    tgt.value = '';
  }).catch(function(err){
    console.error(err);
    showBanner('Errore nel caricare l\'immagine', 'err');
  });
});
$('bgClearBtn').onclick = function(){
  applyBackground(null);
  sendControl({ kind:'bg-clear' });
};
function applyBackground(dataUrl){
  if (dataUrl) { logEl.style.backgroundImage = 'url("' + dataUrl + '")'; }
  else { logEl.style.backgroundImage = 'none'; }
}
function fileToDataUrl(file){
  return new Promise(function(resolve, reject){
    var fr = new FileReader();
    fr.onload = function(){ resolve(fr.result); };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ====== Messaggi ====== */
function sendControl(obj){
  if (!dc || dc.readyState !== 'open') return;
  try { dc.send(JSON.stringify(Object.assign({ t:'ctrl' }, obj))); } catch(e){}
}
function sendText(text){
  if (!dc || dc.readyState !== 'open') return;
  try { dc.send(JSON.stringify({ t:'txt', text: text })); } catch(e){}
}
function handleIncoming(raw){
  try {
    var msg = JSON.parse(raw);
    if (msg.t === 'txt') {
      logBubble('peer', msg.text);
    } else if (msg.t === 'ctrl') {
      if (msg.kind === 'bg' && msg.dataUrl) {
        applyBackground(msg.dataUrl);
        logSys('Sfondo aggiornato dal peer.');
      } else if (msg.kind === 'bg-clear') {
        applyBackground(null);
        logSys('Sfondo rimosso dal peer.');
      }
    } else {
      logBubble('peer', raw);
    }
  } catch {
    logBubble('peer', raw);
  }
}
function sendMessage(){
  var text = $('text').value;
  if (!text) return;
  sendText(text);
  logBubble('me', text);
  $('text').value='';
}

/* ====== Sessione / Signaling ====== */
function startSession(){
  setStatus('preparazione…');
  hideBanner();
  setupPeer();
  openSSE(currentTopic);
  publish({ t:'hello' });
  logSys('Collegamento al signaling…', true);
  logSys('In attesa handshake…', true);
  setStatus('in attesa handshake…');
}

function openSSE(tpc){
  if (sse) { try { sse.close(); } catch(e){} sse = null; }
  var url = SIGNAL_BASE + '/' + tpc + '/sse';
  sse = new EventSource(url);
  sse.onopen = function(){
    sseUp = true; sseBackoff = 1000; sigPill.style.background='#dcfce7'; sigPill.style.border='1px solid #86efac';
    logSys('Collegato al signaling', true); hideBanner();
  };
  sse.onerror = function(){
    if (sseUp) { showBanner('Signaling disconnesso. Riconnessione in corso…', 'warn'); }
    sseUp = false; sigPill.style.background='#fde68a'; sigPill.style.border='1px solid #fbbf24';
    try { sse.close(); } catch {}
    setTimeout(function(){ openSSE(tpc); }, sseBackoff);
    sseBackoff = Math.min(SSE_BACKOFF_MAX, Math.round(sseBackoff * 1.8));
  };
  sse.onmessage = function(ev){
    try {
      var envelope = JSON.parse(ev.data);
      if (!envelope || typeof envelope.message !== 'string') return;
      var msg = JSON.parse(envelope.message);
      if (!msg || msg.from === selfId) return;
      handleSignal(msg);
    } catch (e) { console.warn('SSE parse error', e); }
  };
}

function publish(obj){
  if (!roomCode) return Promise.resolve();
  // pubblica sempre sull'argomento CORRENTE
  var body = JSON.stringify(Object.assign({}, obj, { from: selfId }));
  return fetch(SIGNAL_BASE + '/' + currentTopic, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
    body: body
  }).catch(function(){});
}

/* ====== WebRTC ====== */
function setupPeer(){
  // reset flags per nuova negoziazione
  pendingCandidates = []; remoteSet = false; offerSent = false; answerSent = false;
  if (discTimer) { clearTimeout(discTimer); discTimer = null; }

  pc = new RTCPeerConnection({ iceServers: STUNS.concat(TURNS), iceTransportPolicy: 'all' });

  pc.oniceconnectionstatechange = function(){
    var st = pc.iceConnectionState;
    if (st === 'failed') {
      showBanner('Connessione al peer fallita. Riprovo…', 'err');
      requestSwitch('ice-failed');
    } else if (st === 'disconnected') {
      showBanner('Peer disconnesso. Attendo 2.5s prima di riprovare…', 'warn');
      if (!discTimer) discTimer = setTimeout(function(){ requestSwitch('ice-disconnected'); }, 2500);
    } else if (st === 'connected' || st === 'completed') {
      if (discTimer) { clearTimeout(discTimer); discTimer = null; }
      hideBanner();
    }
  };

  pc.onconnectionstatechange = function(){
    var st = pc.connectionState;
    if (st === 'connected'){
      setStatus('P2P connesso'); setSendEnabled(true);
      clearPrepMessages();
      hideBanner();
      logSys('Chat pronta.');
      switching = false; // sblocco eventuali switch
    } else if (st === 'failed') {
      setStatus('connessione fallita'); setSendEnabled(false);
      requestSwitch('conn-failed');
    } else if (st === 'disconnected') {
      setStatus('connessione persa'); setSendEnabled(false);
      // il timer su iceConnectionState gestisce il retry
    }
  };

  if (isOfferer) {
    dc = pc.createDataChannel('chat');
    wireDC(dc);
  } else {
    pc.ondatachannel = function(ev){ dc = ev.channel; wireDC(dc); };
  }

  pc.onicecandidate = function(ev){
    if (ev && ev.candidate) publish({ t:'candidate', candidate: ev.candidate });
  };
}

function wireDC(ch){
  ch.onopen  = function(){ setSendEnabled(true); hideBanner(); };
  ch.onclose = function(){
    setSendEnabled(false);
    showBanner('Il canale dati si è chiuso. Riprovo a connettere…', 'err');
    if (dcCloseTimer) clearTimeout(dcCloseTimer);
    dcCloseTimer = setTimeout(function(){ requestSwitch('dc-closed'); }, 600);
  };
  ch.onmessage = function(ev){ handleIncoming(ev.data); };
}

/* ====== Riconnessione coordinata (topic switching) ====== */
function requestSwitch(reason){
  if (switching) return;
  switching = true;

  if (isOfferer) {
    // L'offerer coordina: genera nuova "generazione" del topic e annuncia lo switch
    var newGen = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,6);
    publish({ t:'switch', gen: newGen, why: reason }).then(function(){
      // Applica lo switch lato locale dopo un attimo per assicurare la consegna del messaggio
      setTimeout(function(){ applySwitch(newGen); }, 150);
    }).catch(function(){ setTimeout(function(){ applySwitch(newGen); }, 250); });
  } else {
    // Il joiner chiede lo switch; l'offerer deciderà la nuova generazione
    publish({ t:'need-switch', why: reason }).catch(function(){});
  }
}

function applySwitch(newGen){
  // Chiudi peer corrente e prepara nuova sessione su nuovo topic
  cleanupPeer();
  topicGen = newGen;
  currentTopic = buildTopic();
  openSSE(currentTopic);
  setupPeer();
  publish({ t:'hello' });
  setStatus('riconnessione…');
  logSys('Riconnessione in corso…', true);
}

function cleanupPeer(){
  try { if (dc) { dc.onopen = dc.onclose = dc.onmessage = null; dc.close(); } } catch(e){}
  try { if (pc) { pc.oniceconnectionstatechange = pc.onconnectionstatechange = pc.ondatachannel = null; pc.close(); } } catch(e){}
  dc = null; pc = null;
  pendingCandidates = []; remoteSet = false; offerSent = false; answerSent = false;
}

/* ====== Gestione signaling ====== */
function maybeSendOffer(){
  if (!isOfferer || offerSent) return;
  pc.createOffer().then(function(offer){
    return pc.setLocalDescription(offer);
  }).then(function(){
    return publish({ t:'offer', sdp: pc.localDescription });
  }).then(function(){
    offerSent = true;
    logSys('Offer inviata.', true);
  }).catch(function(e){ console.error(e); });
}

function handleSignal(msg){
  if (msg.t === 'hello') {
    logSys('Peer presente.', true);
    maybeSendOffer();

  } else if (msg.t === 'need-switch') {
    // Se sono offerer, decido io nuova generazione
    if (isOfferer) requestSwitch('asked-by-joiner');

  } else if (msg.t === 'switch') {
    // Applica nuova generazione comunicata dall'offerer
    if (msg.gen && typeof msg.gen === 'string') {
      applySwitch(msg.gen);
    }

  } else if (msg.t === 'offer') {
    pc.setRemoteDescription(msg.sdp).then(function(){
      remoteSet = true;
      // flush buffer
      var i; for (i=0;i<pendingCandidates.length;i++){
        pc.addIceCandidate(pendingCandidates[i]).catch(function(e){ console.warn('addIceCandidate buffered fail', e); });
      }
      pendingCandidates = [];
      if (!answerSent) {
        return pc.createAnswer().then(function(ans){
          return pc.setLocalDescription(ans);
        }).then(function(){
          return publish({ t:'answer', sdp: pc.localDescription });
        }).then(function(){
          answerSent = true;
          logSys('Answer inviata.', true);
        });
      }
    }).catch(function(e){ console.error(e); });

  } else if (msg.t === 'answer') {
    pc.setRemoteDescription(msg.sdp).then(function(){
      remoteSet = true;
      var i; for (i=0;i<pendingCandidates.length;i++){
        pc.addIceCandidate(pendingCandidates[i]).catch(function(e){ console.warn('addIceCandidate buffered fail', e); });
      }
      pendingCandidates = [];
    }).catch(function(e){ console.error(e); });

  } else if (msg.t === 'candidate') {
    if (remoteSet && pc.remoteDescription) {
      pc.addIceCandidate(msg.candidate).catch(function(e){ console.warn('addIceCandidate fail', e); });
    } else {
      pendingCandidates.push(msg.candidate);
    }
  }
}

/* ====== Auto-join da URL ====== */
(function(){
  var url = new URL(window.location.href);
  var code = (url.searchParams.get('code') || '').trim().toUpperCase();
  var join = url.searchParams.get('join') === '1';
  if (code) {
    $('joinCode').value = code;
    if (join) {
      isOfferer = false;
      roomCode = code;
      $('codeBox').textContent = code;
      baseTopic = topic(roomCode); topicGen = '0'; currentTopic = buildTopic();
      startSession();
    }
  }
})();

/* ====== Network awareness ====== */
window.addEventListener('offline', function(){ showBanner('Sei offline. Verifica la connessione.', 'warn'); });
window.addEventListener('online',  function(){ hideBanner(); if (currentTopic) openSSE(currentTopic); });

</script>
</body>
</html>
