<!doctype html><html lang="it"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>P2P Chat v0.5f — FHS</title><style>:root{--bg:#000;--bar:#0b1220;--line:#1f2937;--txt:#e5e7eb;--bubble-me:#d4f7c8;--bubble-me-text:#0f2e13;--bubble-peer:#ffffff;--bubble-peer-text:#0b1020;--bubble-old:#d9d9d9;--inset-top:16.14%;--inset-right:16.56%;--inset-bottom:16.35%;--inset-left:16.35%}*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);display:grid;place-items:center;padding:1rem;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}#app{width:512px;height:800px;background:#000;border-radius:12px;overflow:hidden;position:relative;border:1px solid #111}.screen{position:absolute;inset:0;display:none}.screen.active{display:grid}#setup{grid-template-rows:auto 1fr auto}#setup header{padding:.7rem .9rem;background:var(--bar);border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}#setup main{display:grid;place-items:center;padding:1rem}#setup .panel{width:92%;max-width:480px;background:#0b0f1a;border:1px solid #0f172a;border-radius:12px;padding:1rem}.row{display:flex;gap:.6rem;margin:.2rem 0}.col{flex:1}label{display:block;font-size:.9rem;color:#94a3b8;margin:.35rem 0 .2rem}input[type=text],select{width:100%;padding:.6rem .7rem;border:1px solid #223;background:#0b0f1a;color:#fff;border-radius:8px}.radio{display:flex;gap:.8rem;align-items:center;margin:.6rem 0}.radio label{display:flex;align-items:center;gap:.35rem;cursor:pointer;margin:0}.hint{color:#9ca3af;font-size:.85rem;margin-top:.4rem}.btn{padding:.55rem .9rem;border-radius:10px;cursor:pointer;border:1px solid #334155;background:#0f172a;color:#fff;transition:background-color .2s,border-color .2s,color .2s,opacity .2s}.btn.primary{background:#22c55e;border-color:#16a34a;color:#052e14;font-weight:700}.btn:disabled{opacity:1;cursor:not-allowed}.btn.primary:disabled{background:#6b7280;border-color:#4b5563;color:#111827}.pickWrap{display:flex;align-items:center;gap:.6rem}#avatarWrap{display:none}.avatarBox{width:72px;height:72px;border:1px solid #334155;border-radius:12px;background:#0b0f1a;display:grid;place-items:center;cursor:pointer;overflow:hidden}.avatarBox img{width:100%;height:100%;object-fit:cover}#main{grid-template-rows:auto auto auto auto 1fr auto}header.bar{background:var(--bar);border-bottom:1px solid var(--line);padding:.5rem .7rem;display:flex;align-items:center;justify-content:space-between}.status{font-size:.95rem;color:#cbd5e1;font-weight:700}.pill{display:inline-block;padding:.12rem .45rem;border-radius:999px;background:#1f2937;font-size:.72rem;margin-left:.35rem}.controls{display:flex;gap:.35rem}.controls .btn{background:#0f172a;border:1px solid #334155;color:#e5e7eb}.controls .danger{background:#7f1d1d;border-color:#fecaca;color:#fee2e2}#banner{display:none;padding:.45rem .7rem;font-weight:600}.banner-warn{background:#3b2f14;color:#fde68a;border-bottom:1px solid #a16207}.banner-err{background:#3a1b1b;color:#fecaca;border-bottom:1px solid #b91c1c}#info{background:#0b1220;border-bottom:1px solid var(--line);padding:.35rem .6rem;color:#9ca3af}#frameWrap{position:relative;width:100%;aspect-ratio:1/1;background:transparent url("https://massimagnus.github.io/FHS-chat/cornice.png?v=0.5") center/contain no-repeat}#frameWrap.clickable{cursor:pointer}#specchio{position:absolute;inset:var(--inset-top) var(--inset-right) var(--inset-bottom) var(--inset-left);background:#10b981 center/cover no-repeat;border-radius:2px}#feedbackDock{position:absolute;left:8px;right:8px;bottom:64px;display:none;align-items:center;justify-content:center;gap:.5rem;padding:.4rem .6rem;background:#0b1220;border:1px solid #334155;border-radius:10px;z-index:70}#fbControls{display:flex;align-items:center;gap:.45rem}#fbControls select{background:#0f172a;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:.35rem .5rem}.swatches{display:flex;gap:.25rem}.swatch{width:18px;height:18px;border-radius:50%;border:1px solid #ffffff33;cursor:pointer}.swatch.sel{outline:2px solid #fff}#fbSend{background:#22c55e;border:1px solid #16a34a;color:#052e14;border-radius:8px;padding:.35rem .6rem;font-weight:700}#serverPop{display:none;padding:.35rem .6rem;border-radius:10px;background:#111827;color:#e5e7eb;border-left:6px solid #8b5cf6;font-weight:700}#names{display:grid;grid-template-columns:1fr 1fr;padding:.35rem .6rem .1rem;font-weight:800;color:#cbd5e1;font-size:.95rem}#names div{text-align:center}#chat{display:grid;grid-template-rows:auto 1fr;padding:.2rem .6rem .4rem}#grid{display:grid;grid-template-columns:1fr 1fr;gap:.35rem;overflow:hidden}.colList{display:flex;flex-direction:column;gap:.3rem;overflow:hidden}.colList.client{align-items:flex-end}.colList.server{align-items:flex-start}.colList.client .bubble{text-align:right}.colList.server .bubble{text-align:left}.bubble{display:inline-block;max-width:90%;padding:.5rem .7rem;border-radius:.9rem;box-shadow:0 1px 0 rgba(0,0,0,.35);white-space:pre-wrap;line-height:1.25;transition:filter .25s,opacity .25s,transform .25s;overflow:hidden;word-break:break-word;overflow-wrap:anywhere}.colList.server .bubble.last{background:var(--bubble-me);color:var(--bubble-me-text);border:1px solid #a7e3a0;font-size:1rem;transform:scale(1)}.colList.client .bubble.last{background:var(--bubble-peer);color:var(--bubble-peer-text);border:1px solid #e5e7eb;font-size:1rem;transform:scale(1)}.bubble:not(.last){background:var(--bubble-old);color:#1b1b1b;border:1px solid #c9c9c9;opacity:.78;filter:saturate(.7);font-size:.84rem;transform:scale(.95)}.bubble.custom{border:1px solid rgba(0,0,0,.18)!important}.composer{position:sticky;bottom:0;z-index:60;background:var(--bar);border-top:1px solid var(--line);padding:.5rem .6rem;display:flex;gap:.45rem;align-items:center}#text{flex:1;padding:.7rem .9rem;border:1px solid #475569;border-radius:999px;background:#0f172a;color:#e5e7eb;caret-color:#e5e7eb;font-size:1.05rem}#text::placeholder{color:#94a3b8}#sendBtn{display:none}#history{position:absolute;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}#history .card{width:86%;max-width:480px;max-height:70%;background:#0b0f1a;border:1px solid #334155;border-radius:12px;display:flex;flex-direction:column;color:#e5e7eb}#history header{padding:.5rem .7rem;font-weight:700;border-bottom:1px solid #334155;display:flex;justify-content:space-between;align-items:center;gap:.5rem}#history main{padding:.6rem .7rem;overflow:auto}.hrow{display:flex;gap:.5rem;margin:.15rem 0}.hwho{width:80px;font-weight:700;color:#9ca3af}.htext{flex:1}#jsErr{position:absolute;left:12px;right:12px;bottom:12px;background:#3a1b1b;color:#fee2e2;padding:.5rem .75rem;border:1px solid #b91c1c;border-radius:8px;display:none;font-weight:700}</style></head><body><div id="app"><section id="setup" class="screen active"><header><strong>Impostazioni</strong><span style="color:#9ca3af">P2P WebRTC — v0.5f</span></header><main><div class="panel"><div class="row"><div class="col"><label for="nickMe">Il tuo nickname</label><input id="nickMe" type="text" placeholder="Es. Marco" maxlength="24"></div><div class="col" id="roomCol"><label id="roomLabel" for="room">Codice stanza (solo CLIENT)</label><input id="room" type="text" placeholder="Es. P2P-AB123" maxlength="48"></div></div><div class="row"><div class="col"><label for="genderSel">Genere</label><select id="genderSel"><option value="">Seleziona…</option><option>uomo</option><option>donna</option><option>transgender</option><option>uomo effeminato</option><option>donna mascolina</option><option>indeterminato</option></select></div><div class="col"><label for="ageSel">Età apparente</label><select id="ageSel"><option value="">Seleziona…</option><option>adolescente</option><option>giovane</option><option>adulta</option><option>matura</option><option>anziana</option><option>vecchia</option></select></div></div><div class="row"><div class="col"><label>Icona personaggio</label><div class="pickWrap" id="avatarWrap"><div class="avatarBox" id="avatarBox" title="Clicca per cambiare"><img id="avatarImg" alt="avatar" src=""></div></div></div></div><div class="radio"><label><input type="radio" name="role" value="server" checked> SERVER (crea)</label><label><input type="radio" name="role" value="client"> CLIENT (entra)</label></div><div class="row"><button id="btnStart" class="btn primary" style="flex:1" disabled title="Completa: Nickname, Genere, Età apparente">Avvia</button><button id="btnPaste" class="btn" title="Incolla codice dagli appunti">Incolla codice</button></div><div class="hint">SERVER: dai un nome alla stanza (opzionale). CLIENT: inserisci il codice stanza. L’icona appare dopo aver completato nick+genere+età.</div></div></main><footer style="padding:.65rem .9rem;color:#9ca3af;border-top:1px solid #1f2937">Nessun dato su server: il flusso viaggia P2P tra i browser.</footer></section><section id="main" class="screen"><header class="bar"><div class="status" id="status">offline</div><div class="controls"><span id="pillSSE" class="pill">SSE</span><span class="pill">v0.5f</span><button id="btnHistory" class="btn">STORIA</button><button id="btnQuit" class="btn danger">ESCI</button></div></header><div id="banner" role="status"></div><div id="info">Codice: <strong id="codeBox">—</strong></div><div id="frameWrap"></div><div id="feedbackDock"><div id="fbControls"><span style="color:#9ca3af">Feedback:</span><select id="fbSelect"><option>Vergogna</option><option>Inguardabile!</option><option>No grazie!</option><option>Noia</option><option>Indifferente</option><option>Rilassante</option><option>Piacevole</option><option>In estasi!</option><option>Da brividi!</option><option>Sconvolgente!</option><option>Fastidio</option><option>Paura!</option><option>Aiuto!</option></select><div class="swatches" id="fbSwatches"></div><button id="fbSend">Invia</button></div><div id="serverPop">reazione: …</div></div><div id="names"><div id="nameClient">CLIENT</div><div id="nameServer">SERVER</div></div><div id="chat"><div id="grid"><div id="colClient" class="colList client"></div><div id="colServer" class="colList server"></div></div></div><div class="composer"><input id="text" type="text" placeholder="Scrivi un messaggio…"><button id="sendBtn" disabled>Invia</button></div></section><div id="history"><div class="card"><header><span>Storia conversazione</span><span><button id="btnCopyHist" class="btn">Copia log</button><button id="btnCloseHist" class="btn">Chiudi</button></span></header><main id="histBody"></main></div></div><div id="jsErr"></div><input id="fileSpec" type="file" accept="image/*" style="display:none"></div><script>const APP_VERSION="0.5f";const FRAME_SRC="https://massimagnus.github.io/FHS-chat/cornice.png?v=0.5";const FB_COLORS=["rgb(180,180,180)","rgb(190,160,200)","rgb(205,130,215)","rgb(220,100,230)","rgb(235,70,242)","rgb(245,35,250)","rgb(255,0,255)"];const IMG_BASE="images/";function setScreen(e){var t=document.getElementById("setup"),n=document.getElementById("main");t&&t.classList.remove("active"),n&&n.classList.remove("active");var a=document.getElementById(e);a&&a.classList.add("active")}(()=>{"use strict";var e=[{urls:"stun:stun.l.google.com:19302"}],t=[],n=null,a=null,o=null,i=!1,r=null,l=null,s="0",c=null,d=crypto.getRandomValues(new Uint32Array(1))[0].toString(16),u=[],m=!1,v=!1,f=!1,p=1e3,h=1e4,g=!1,y=!1,b=null,S=null,w="Io",E="Peer",L=[],C=!0,k=null,x=!1,T=3,A={gender:"",age:""},B=null,M=!1,O=IMG_BASE+"cl01.png",D=1;function N(e){return document.getElementById(e)}function I(e,t){var n=N("banner");n&&(n.textContent=e,n.className="err"===t?"banner-err":"banner-warn",n.style.display="block")}function R(){var e=N("banner");e&&(e.style.display="none",e.textContent="",e.className="")}function q(e){var t=N("status");t&&(e&&B?t.textContent="Stanza: "+B:t.textContent="offline")}function _(e){return"P2P-"+Math.random().toString(36).slice(2,7).toUpperCase()}function H(e){return"p2pchat-"+e}function P(){return l+"-"+s}function z(){var e=(new URL(location.href),new URL(location.href));return e.origin+e.pathname}function j(e){var t=new URL(z());return t.searchParams.set("code",e),t.searchParams.set("join","1"),t.searchParams.set("v",APP_VERSION),t.toString()}function F(){N("nameClient").textContent="CLIENT: "+(i?E:w),N("nameServer").textContent="SERVER: "+(i?w:E)}function G(e,t){t=t||3;for(;e.children.length>t;)e.removeChild(e.lastChild)}function J(e,t){var n="client"===e?N("colClient"):N("colServer");if(n){var a=n.querySelector(".bubble.last");a&&a.classList.remove("last");var o=document.createElement("div");o.className="bubble last",o.textContent=t,n.firstChild?n.insertBefore(o,n.firstChild):n.appendChild(o),G(n,3),C&&L.push({side:e,text:t})}}function K(e,t,n){var a="client"===e?N("colClient"):N("colServer");if(a){var o=a.querySelector(".bubble.last");o&&o.classList.remove("last");var i=document.createElement("div");i.className="bubble last custom",i.textContent=t,n&&(i.style.background=n),a.firstChild?a.insertBefore(i,a.firstChild):a.appendChild(i),G(a,3),C&&L.push({side:e,text:t})}}function Q(){var e=N("histBody");if(e){e.innerHTML="";for(var t=0;t<L.length;t++){var n=L[t],a=document.createElement("div");a.className="hrow";var o=document.createElement("div");o.className="hwho",o.textContent=n.side.toUpperCase();var i=document.createElement("div");i.className="htext",i.textContent=n.text,a.appendChild(o),a.appendChild(i),e.appendChild(a)}}}function U(e){return(e<10?"0":"")+e}function V(){var e=document.querySelector('input[name="role"]:checked'),t=!e||"server"===e.value,n=N("genderSel").value.toLowerCase(),a=[];for(var o=1;o<=16;o++)if(t)"uomo"!==n&&"uomo_
